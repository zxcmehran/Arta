var ArtaCalendarStore={weekdays:new Array("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"),short_weekdays:new Array("Sun","Mon","Tue","Wed","Thu","Fri","Sat"),gregorian_months:new Array("January","February","March","April","May","June","July","August","September","October","November","December"),jalali_months:new Array("Farvardin","Ordibehest","Khordad","Tir","Mordad","Shahrivar","Mehr","Aban","Azar","Dey","Bahman","Esfand"),gregorian_weekday:new Array(0,0,1,2,3,4,5,6),jalali_weekday:new Array(6,6,0,1,2,3,4,5),g_days_in_month:new Array(31,28,31,30,31,30,31,31,30,31,30,31),j_days_in_month:new Array(31,31,31,31,31,31,30,30,30,30,30,29),lang:new Array("Today","Previous year","Previous month","Next month","Next year","Close","Refresh","in Jalali Calendar","in Gregorian Calendar","Selected Date")};var ArtaCalendar=Class.create({date:{},target:null,params:null,today:new Date(),rand:null,container:null,initialize:function(b,e){function a(f,g){if(Object.isUndefined(e[f])==true){e[f]=g}}this.target=$(b);if(this.target==null){alert('Invalid Target "'+b+'" for ArtaCalendar.');return false}a("type","gregorian");a("parent",false);a("handler",b);a("format","%Y-%m-%d %H:%i:%s");a("onChangeValue",Prototype.emptyFunction);a("onOpen",Prototype.emptyFunction);if(e.parent!==false){e.parent=$(e.parent)}e.handler=$(e.handler);this.params=e;this.rand=parseInt(Math.random()*100000);this.load();return true},load:function(){if(this.params.parent!==false){this.open(-1)}else{this.params.handler.observe("click",this.open.bindAsEventListener(this))}},open:function(){this.parseDate();if(arguments[0]!=-1&&typeof arguments[0]=="number"){this.params.onChangeValue.bindAsEventListener(this)()}else{this.params.onOpen.bindAsEventListener(this)();if(arguments[0]==-1){arguments[0]=0}}this.drawHTML();if(this.params.parent==false){pos=Element.cumulativeOffset(this.params.handler);pos2=Element.cumulativeOffset(this.target);if(pos[1]+this.container.getHeight()>document.viewport.getHeight()){this.container.setStyle({top:(pos[1]-this.container.getHeight()-10)+"px"})}else{this.container.setStyle({top:(pos[1]+10)+"px"})}if(pos2[0]>pos[0]){this.container.setStyle({left:(pos[0]-this.container.getWidth()-10)+"px",display:"none"})}else{this.container.setStyle({left:(pos[0]+10)+"px",display:"none"})}if(typeof arguments[0]!=="number"){new Effect.Appear(this.container,{duration:0.3})}else{if(arguments[0]==0){this.container.show()}else{new Effect.Appear(this.container,{duration:parseInt(arguments[0])})}}}},parseDate:function(){this.date.y=this.today.getFullYear();this.date.m=this.today.getMonth()+1;this.date.d=this.today.getDate();this.date.weekday=this.today.getDay();this.date.hour=this.today.getHours();this.date.min=this.today.getMinutes();this.date.sec=this.today.getSeconds();if(this.params.type=="jalali"){jalali=this.gregorian_to_jalali(this.date.y,this.date.m,this.date.d);this.date.y=jalali[0];this.date.m=jalali[1];this.date.d=jalali[2]}if(this.target.tagName=="INPUT"){str=this.target.value}else{str=this.target.innerHTML}var f=str.split(/\W+/);var e=this.params.format.match(/%./g);var g=0;for(g=0;g<f.length;++g){if(!f[g]){continue}switch(e[g]){case"%d":case"%j":this.date.d=parseInt(f[g],10);break;case"%m":case"%n":this.date.m=parseInt(f[g],10);break;case"%Y":case"%y":this.date.y=parseInt(f[g],10);break;case"%H":case"%G":this.date.hour=parseInt(f[g],10);break;case"%i":this.date.min=parseInt(f[g],10);break;case"%s":this.date.sec=parseInt(f[g],10);break}}},drawHTML:function(){if(this.container!==null){this.container.remove();this.container=null}var b=this.params.type=="jalali"?this.gregorian_to_jalali(parseInt(this.today.getFullYear()),parseInt(this.today.getMonth())+1,parseInt(this.today.getDate())):new Array(parseInt(this.today.getFullYear()),parseInt(this.today.getMonth())+1,parseInt(this.today.getDate()));var e=this.date;var k=ArtaCalendarStore.lang;var f=this.rand;var a=ArtaCalendarStore.weekdays;var h=ArtaCalendarStore.short_weekdays;if(this.params.type=="jalali"){month_days=ArtaCalendarStore.j_days_in_month;if((e.m==1&&[1,5,9,13,18,22,26,30].indexOf((e.y-1)%33)>0)||(e.m==12&&[1,5,9,13,18,22,26,30].indexOf((e.y)%33)>0)){month_days[11]=30}else{month_days[11]=29}week=ArtaCalendarStore.jalali_weekday;month=ArtaCalendarStore.jalali_months[e.m-1]}else{month_days=ArtaCalendarStore.g_days_in_month;if((e.m==2||e.m==3)&&((e.y)%400==0||((e.y)%4==0&&(e.y)%100!=0))){month_days[1]=29}else{month_days[1]=28}week=ArtaCalendarStore.gregorian_weekday;month=ArtaCalendarStore.gregorian_months[e.m-1]}if(!(e.m>0&&e.m<13)||!(e.d>0&&e.d<=month_days[e.m-1])){alert("Invalid Date value specified.");return false}divElement=new Element("DIV",this.params.parent==false?{style:"position: absolute;"}:{});divElement.observe("click",this.onClick.bindAsEventListener(this));prev_y=(e.y-1)+"-"+e.m+"-"+e.d;prev_m=e.y+"-"+(e.m-1)+"-"+e.d;if((e.m-1)<1){prev_m=(e.y-1)+"-"+12+"-"+e.d}next_m=e.y+"-"+(e.m+1)+"-"+e.d;if((e.m+1)>12){next_m=(e.y+1)+"-"+1+"-"+e.d}next_y=(e.y+1)+"-"+e.m+"-"+e.d;if(this.params.parent==false){exit='<th title="'+k[5]+'" id="'+f+'_exit" class="close">x</th>'}else{exit='<th title="'+k[6]+'" id="'+f+'_refresh" class="close">#</th>'}var g='<table><thead><tr><th colspan="6">'+month+" - "+e.y+"</th>"+exit+'</tr></thead><tr class="controls"><td id="'+f+"_goto_"+prev_y+'" title="'+k[1]+'">&lt;&lt;</td><td id="'+f+"_goto_"+prev_m+'" title="'+k[2]+'">&lt;</td><td id="'+f+"_setvalue_"+b[0]+"-"+b[1]+"-"+b[2]+'" colspan="3">'+k[0]+'</td><td id="'+f+"_goto_"+next_m+'" title="'+k[3]+'">&gt;</td><td id="'+f+"_goto_"+next_y+'" title="'+k[4]+'">&gt;&gt;</td></tr>';days=new Array();s_days=new Array();g+='<tr class="weekdays">';for(i=0;i<7;i++){days[i]=a[week[i+1]];s_days[i]=h[week[i+1]];if(s_days[i]==s_days[week[0]]){c=' class="weekend"'}else{c=""}g+="<td"+c+"><b>"+s_days[i]+"</b></td>"}g+="</tr>";if(this.params.type=="jalali"){month_start=this.getJalaliMonthStartWeekday();month_start+=1;if(month_start>6){month_start-=7}}else{month_start=this.getMonthStartWeekday()}trows=1;g+="<tr>";weeknow=month_start;now=1;if(month_start==0){j=7;while(j>0){last=month_days[e.m==1?11:e.m-2]-j+1;g+='<td id="'+f+"_setvalue_"+(e.m==1?e.y-1:e.y)+"-"+(e.m==1?12:e.m-1)+"-"+last+'" class="other_months">'+last+"</td>";j--}g+="</tr><tr>";trows++}while(now<=month_days[e.m-1]){while(month_start>0){last=month_days[e.m==1?11:e.m-2]-month_start+1;g+='<td id="'+f+"_setvalue_"+(e.m==1?e.y-1:e.y)+"-"+(e.m==1?12:e.m-1)+"-"+last+'" class="other_months">'+last+"</td>";month_start--}if(weeknow==7){weeknow=0;g+="</tr><tr>";trows++}if(now==e.d){class_sel="selected";lang_sel=k[9]+" - "}else{class_sel="";lang_sel=""}if(this.params.type=="jalali"){g_date=this.jalali_to_gregorian(e.y,e.m,now);transed=g_date[0]+"-"+g_date[1]+"-"+g_date[2]+" "+k[8]}else{j_date=this.gregorian_to_jalali(e.y,e.m,now);transed=j_date[0]+"-"+j_date[1]+"-"+j_date[2]+" "+k[7]}if(b[0]==e.y&&b[1]==e.m&&b[2]==now){if(class_sel!==""){class_sel=" "+class_sel}g+='<td id="'+f+"_setvalue_"+e.y+"-"+e.m+"-"+now+'" class="today'+class_sel+'" title="'+lang_sel+k[0]+" - "+transed+'">'+now+"</td>"}else{if(class_sel!==""){class_sel=' class="'+class_sel+'"'}g+='<td id="'+f+"_setvalue_"+e.y+"-"+e.m+"-"+now+'"'+class_sel+' title="'+lang_sel+transed+'">'+now+"</td>"}now++;weeknow++}last=1;while(weeknow+last<8){g+='<td id="'+f+"_setvalue_"+(e.m==12?e.y+1:e.y)+"-"+(e.m==12?1:e.m+1)+"-"+last+'" class="other_months">'+last+"</td>";last++}last2=1;if(trows!==6){g+="</tr><tr>";while(last2<8){g+='<td id="'+f+"_setvalue_"+(e.m==12?e.y+1:e.y)+"-"+(e.m==12?1:e.m+1)+"-"+last+'" class="other_months">'+last+"</td>";last++;last2++}}g+="</tr>";g+="</table>";Element.update(divElement,g);if(this.params.parent==false){par=document.body}else{par=this.params.parent}divElement.writeAttribute("class","calendar");par.appendChild(divElement);this.container=divElement},onClick:function(a){el=a.element();elid=el.id.split("_");if(parseInt(elid[0])==this.rand){switch(elid[1]){case"exit":this.close();break;case"refresh":this.close(0);this.open(0);break;case"goto":case"setvalue":if(this.target.tagName=="INPUT"){this.target.value=this.createDate(elid[2])}else{this.target.innerHTML=this.createDate(elid[2])}this.close((elid[1]=="goto"||this.params.parent!==false)?0:null);if(elid[1]=="goto"||this.params.parent!==false){this.open(0)}}}},close:function(){if(typeof arguments[0]!=="number"){new Effect.Fade(this.container,{duration:0.3,afterFinish:function(){this.container.remove();this.container=null}.bindAsEventListener(this)})}else{if(arguments[0]==0){this.container.remove();this.container=null}else{new Effect.Fade(this.container,{duration:parseInt(arguments[0]),afterFinish:function(){this.container.remove();this.container=null}.bindAsEventListener(this)})}}},createDate:function(g){date=g.split("-");weekday=this.today.getDay();hour=this.today.getHours();min=this.today.getMinutes();sec=this.today.getSeconds();var f=new String();var a=this.params.format.match(/(%.|[^%]*)/g);var e=0;for(e=0;e<a.length;e++){switch(a[e]){case"%d":case"%j":f+=date[2];break;case"%m":case"%n":f+=date[1];break;case"%Y":case"%y":f+=date[0];break;case"%H":case"%G":f+=hour;break;case"%i":f+=min;break;case"%s":f+=sec;break;default:f+=a[e]}}return f},getJalaliMonthStartWeekday:function(){d=this.jalali_to_gregorian(this.date.y,this.date.m,1);gd=new Date(d[0],d[1]-1,d[2]);return gd.getDay()},getMonthStartWeekday:function(b,a){d=new Date(this.date.y,this.date.m-1,1);return d.getDay()},gregorian_to_jalali:function(b,e,a){g_days_in_month=new Array(31,28,31,30,31,30,31,31,30,31,30,31);j_days_in_month=new Array(31,31,31,31,31,31,30,30,30,30,30,29);gy=b-1600;gm=e-1;gd=a-1;g_day_no=365*gy+this.div(gy+3,4)-this.div(gy+99,100)+this.div(gy+399,400);for(i=0;i<gm;++i){g_day_no+=g_days_in_month[i]}if(gm>1&&((gy%4==0&&gy%100!=0)||(gy%400==0))){g_day_no++}g_day_no+=gd;j_day_no=g_day_no-79;j_np=this.div(j_day_no,12053);j_day_no=j_day_no%12053;jy=979+33*j_np+4*this.div(j_day_no,1461);j_day_no%=1461;if(j_day_no>=366){jy+=this.div(j_day_no-1,365);j_day_no=(j_day_no-1)%365}for(i=0;i<11&&j_day_no>=j_days_in_month[i];++i){j_day_no-=j_days_in_month[i]}jm=i+1;jd=j_day_no+1;return new Array(jy,jm,jd)},jalali_to_gregorian:function(b,e,a){g_days_in_month=new Array(31,28,31,30,31,30,31,31,30,31,30,31);j_days_in_month=new Array(31,31,31,31,31,31,30,30,30,30,30,29);jy=b-979;jm=e-1;jd=a-1;j_day_no=365*jy+this.div(jy,33)*8+this.div(jy%33+3,4);for(i=0;i<jm;++i){j_day_no+=j_days_in_month[i]}j_day_no+=jd;g_day_no=j_day_no+79;gy=1600+400*this.div(g_day_no,146097);g_day_no=g_day_no%146097;leap=true;if(g_day_no>=36525){g_day_no--;gy+=100*this.div(g_day_no,36524);g_day_no=g_day_no%36524;if(g_day_no>=365){g_day_no++}else{leap=false}}gy+=4*this.div(g_day_no,1461);g_day_no%=1461;if(g_day_no>=366){leap=false;g_day_no--;gy+=this.div(g_day_no,365);g_day_no=g_day_no%365}for(i=0;g_day_no>=g_days_in_month[i]+(i==1&&leap);i++){g_day_no-=g_days_in_month[i]+(i==1&&leap)}gm=i+1;gd=g_day_no+1;return new Array(gy,gm,gd)},div:function(f,e){return parseInt(f/e)}});